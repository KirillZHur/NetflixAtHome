input {
  gelf {
    port => 12201
  }
}

filter {
  if [tag] and ![service] {
    mutate { add_field => { "service" => "%{tag}" } }
  }

  if [container_name] and ![container] {
    mutate { add_field => { "container" => "%{container_name}" } }
  }

  if [image_name] and ![image] {
    mutate { add_field => { "image" => "%{image_name}" } }
  }

  json {
    source => "message"
    target => "app"
    skip_on_invalid_json => true
  }

  if [app][record][level][name] and ![level] {
    mutate { add_field => { "level" => "%{[app][record][level][name]}" } }
  }

  if [app][record][message] and ![msg] {
    mutate { add_field => { "msg" => "%{[app][record][message]}" } }
  }

  if [app][record][extra][service] {
    mutate { replace => { "service" => "%{[app][record][extra][service]}" } }
  }

  if [app][record][extra][env] {
    mutate { add_field => { "env" => "%{[app][record][extra][env]}" } }
  }

  if [app][record][extra][request_id] {
    mutate { add_field => { "request_id" => "%{[app][record][extra][request_id]}" } }
  }

  if [app][record][extra][trace_id] {
    mutate { add_field => { "trace_id" => "%{[app][record][extra][trace_id]}" } }
  }

  if ![level] {
    mutate { add_field => { "level" => "INFO" } }
  }

  if [msg] {
    mutate { replace => { "message" => "%{msg}" } }
  }

  mutate {
    strip => ["service", "container", "image", "level"]
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS}"]
    index => "${LOG_INDEX_PREFIX}-%{+YYYY.MM.dd}"
  }
}
